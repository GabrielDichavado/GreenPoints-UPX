<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo - Green Points</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>

    <!-- NAVBAR -->
    <div id="navbar"></div>

    <main class="container">
        <h1>Painel Administrativo</h1>
        <p>Use esta página para gerenciar a pontuação dos usuários.</p>

        <section class="admin-card">
            <h2>Adicionar Pontos</h2>

            <form id="adminPointsForm">
                <label for="email">E-mail do usuário:</label>
                <input type="email" id="email" required placeholder="usuario@email.com">

                <label for="points">Pontos a adicionar:</label>
                <input type="number" id="points" required min="1">

                <button type="submit" class="btn-primary">Adicionar</button>
            </form>

            <p id="adminMessage"></p>
        </section>

        <section class="admin-history">
            <h2>Histórico Recentes</h2>
            <ul id="historyList"></ul>
        </section>
    </main>

    <script type="module">
        import { protectPage } from "./js/authGuard.js";
        import { loadNavbar } from "./js/navbar.js";
        import { db } from "./js/firebaseConfig.js";

        import {
            getDocs,
            getDoc,
            setDoc,
            updateDoc,
            collection,
            doc,
            query,
            where,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Proteção da página → somente admin acessa
        protectPage("admin");

        // Carregar navbar
        loadNavbar();

        const form = document.getElementById("adminPointsForm");
        const message = document.getElementById("adminMessage");
        const historyList = document.getElementById("historyList");

        // Carregar últimos históricos
        async function loadRecentHistory() {
            historyList.innerHTML = "<li>Carregando...</li>";

            const usersRef = collection(db, "users");
            const docsSnap = await getDocs(usersRef);

            let historyItems = [];

            docsSnap.forEach(docSnap => {
                const data = docSnap.data();
                if (data.history) {
                    data.history.forEach(h => {
                        historyItems.push({
                            user: data.email,
                            action: h
                        });
                    });
                }
            });

            historyItems.reverse().slice(0, 8).forEach(item => {
                historyList.innerHTML += `<li><strong>${item.user}:</strong> ${item.action}</li>`;
            });
        }
        loadRecentHistory();

        // FORM - Adicionar Pontos
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const email = document.getElementById("email").value;
            const points = parseInt(document.getElementById("points").value);

            message.innerHTML = "Processando...";

            try {
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("email", "==", email));
                const snap = await getDocs(q);

                if (snap.empty) {
                    message.innerHTML = "Usuário não encontrado!";
                    return;
                }

                const userDoc = snap.docs[0];
                const userRef = doc(db, "users", userDoc.id);
                const userData = userDoc.data();

                const newPoints = (userData.points || 0) + points;

                await updateDoc(userRef, {
                    points: newPoints,
                    history: arrayUnion(`+${points} pontos adicionados em ${new Date().toLocaleString()}`)
                });

                message.innerHTML = "Pontos adicionados com sucesso!";
                loadRecentHistory();

            } catch (error) {
                console.error(error);
                message.innerHTML = "Erro ao adicionar pontos.";
            }
        });
    </script>

</body>
</html>
